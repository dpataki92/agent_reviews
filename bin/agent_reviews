#!/usr/bin/env bash
set -euo pipefail

resolve_bin_dir() {
  local src="${BASH_SOURCE[0]}"

  while [[ -L "$src" ]]; do
    local dir
    dir="$(cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done

  cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd
}

BIN_DIR="$(resolve_bin_dir)"
TOOL_DIR="$(cd "$BIN_DIR/.." >/dev/null 2>&1 && pwd)"
ORIG_CWD="$(pwd)"

has_repo_arg=false
for a in "$@"; do
  if [[ "$a" == "-C" || "$a" == "--repo" ]]; then
    has_repo_arg=true
    break
  fi
done

ARGS=("$@")
if [[ "$has_repo_arg" == "false" ]]; then
  ARGS=("-C" "$ORIG_CWD" "${ARGS[@]}")
fi

# Used by the Elixir script to print the correct command name in summaries.
export AGENT_REVIEWS_INVOKE="${AGENT_REVIEWS_INVOKE:-$(basename "$0")}"

# Prefer Homebrew Elixir if present.
ELIXIR_BIN=""
if [[ -x /opt/homebrew/bin/elixir ]]; then
  ELIXIR_BIN="/opt/homebrew/bin/elixir"
elif [[ -x /usr/local/bin/elixir ]]; then
  ELIXIR_BIN="/usr/local/bin/elixir"
elif command -v elixir >/dev/null 2>&1; then
  ELIXIR_BIN="$(command -v elixir)"
fi

if [[ -z "$ELIXIR_BIN" ]]; then
  echo "ERROR: Missing dependency: 'elixir' (expected on PATH)." >&2
  echo "Hint: install Elixir (Homebrew or asdf)." >&2
  exit 1
fi

if [[ "$ELIXIR_BIN" == "/opt/homebrew/bin/elixir" ]]; then
  # Ensure Homebrew Elixir runs with Homebrew Erlang (avoid asdf-shim OTP mismatches).
  export PATH="/opt/homebrew/bin:/opt/homebrew/opt/erlang/bin:${PATH}"
fi

if [[ -x "$TOOL_DIR/agent_reviews" ]]; then
  exec "$TOOL_DIR/agent_reviews" "${ARGS[@]}"
fi

cd "$TOOL_DIR"
exec "$ELIXIR_BIN" -S mix run -e 'AgentReviews.CLI.main(System.argv())' -- "${ARGS[@]}"
